---
layout: post
title: [译]Oracle 超大数据及表分区指导
categories: [Database, Oracle]
description: Oracle 超大数据及表分区指导
keywords: Oracle, VLDB, 超大数据表, 表分区, Partitioning
---
> [Oracle docs原文地址](https://docs.oracle.com/cd/B28359_01/server.111/b32024/intro.htm)

**目录**

* TOC
{:toc}

# [译]超大数据库及分区指导(Database VLDB and Partitioning Guide)
## 1 Oracle 超大数据库介绍
### 分区的介绍
分区操作允许你将超大的表和索引分解成更小的更易管理的片，我们称之为分区。分区对应用完全透明。SQL查询和DML完全不用修改。DDL可以直接操作单个分区，而不是整个表或索引，以此简化大数据库对象的管理。  

每个表或索引的分区可以必须有相同的逻辑属性，例如列名，数据类型和约束，每个分许允许有独立的物理属性，例如压缩设置、物理存储设置和表空间。  

分区对很多应用都非常有帮助，尤其是处理大量的数据时，OLTP系统可以用来提升管理和易用性。数据仓库系统也可用来提升性能和管理。

分区的优势如下：
* 可以在分区级别加载数据，新建或重建索引，备份还原数据，显著的缩短这些操作的执行时间。
* 提升查询性能。通过分区，可以提升获得数量级的性能优化。
* 减少停机时间。

  分区独立于分区的维护操作，这一特性可以让你并行维护同一个表或索引的不同分区，可以在不受影响的分区上继续执行`SELECT`和DML操作。
* 提升关键任务系统的可靠性。分区可以减少维护窗口、恢复时间和失败影响。
* 优化系统可用性、缩短运行时间。分区的并行执行是集群环境可伸缩的基础。并行执行支持普通查询、DML和DDL。

分区提升了Oracle 数据库数据的访问数据。可以提供数量级的数据访问优化。不需要修改现有应用。

### 超大数据库（VLDB）和分区
对数据库多大算VLDB， 并没有标准。VLDB和小数据库类似，但是管理很有挑战，这些挑战主要提现单表巨大的体量及操作该体量数据的代价上。在小数据库上这些操作都是很想当然的操作。

如下趋势增加了数据库的体积：
* 以前数据系统是独立建设的，企业开始意识到组合这些系统可以方便的跨部门分析，并且可以减少维护成本。数据库和系统的整合是数据库体积增加的主要因素。
* 法律法规强制要求企业数据至少保持最短时间，造成企业需要存储更长周期的数据。
*  企业发展、企业合并、企业收购导致数据量增长。依赖数据库进行日常活动的用户量也显著增长。

分区是操作大数据库的关键特性，数量的增加是大数据库最基本挑战，分区使用“分而治之”的思想管理表和索引，尤其是不断增大的表和索引。分区可以使你在不过度增加管理或硬件资源的前提下，允许您扩展到非常大的数量级同时保持一致的性能表现。

### 分区是信息生命周期管理(ILM, Information Lifecycle Management)的基础
ILM的核心理念为处于不同生命周期的数据分配合适的存储介质：新的、常用的数据分配在快速的高可用的存储层；老的，不常用数据分配在更廉价的，性能比较差的存储层。可以将不常用的老数据压缩打包。

ILM基础操作、打包、清理或删除老数据时，如果使用分区的技术，将有数量级别的提升。

### 每个数据库都可以分区
不知是大数据库需要分许，小数据库也可以从分许中获益。

## 2 分区的概念
分区提升各种应用的性能、可管理性、易用性，减少存储大量数据的成本。分区可以将表、索引、索引组织的表分成更小的片，使数据在更好的间隔上进行管理和访问。Oracle提供了多种分区策略。分区对应用完全透明，避免了潜在的程应用修改需要的金钱和时间成本。
### 分区基础知识
分区操作将表、索引、索引组织的表拆分成更小的，叫做分区的单位。每个分区有自己的名字，可以有自己的存储特性。

从数据库管理的角度来说，分许可以统一或单独管理，这带给数据库管理员管理分区对象的巨大灵活性。从应用的角度看分区表和不分区表没有任何区别，不需要修改SQL查询和DML语句。

下图展示分区表和非分区表差异

![Figure 2-1](/images/Posts/OracleVLDBPartitioning/2-1.gif)

#### 分区键
被分区的表的行被明确的分拆到了单个分区中。分区键由一个或多个列组成，用来决定行应该存在哪个分区中。Oracle自动用分区键来确定对正确的分区进行增删改。
#### 分区表
只要不包含`LONG` `LONG RAW`类型的表都可以被分成百万个分区。

##### 何时应该分区表
  关于分区表的一些建议：
* 单表大于2G时，建议分区。
* 表包含历史数据，新数据添加到最新的分区。典型的例子是只有当前月的数据是需要修改的，其他11个月的数据是只读的。
* 表的数据需要跨不同的存储设备时。

##### 何时应该分区索引
关于分区索引的建议：
* 避免删除数据时重建整个索引。
* 修改部分数据，不影响整体索引。
* 减少索引列单调增长引起的索引倾斜照成的影响。

#### 索引组织表分区
当分区索引组织表时
* 分区字段必须是主键的子集。
* 第二索引可以被分区（包括本地和全局）
* `OVERFLOW`的数据段的分区和表的分区相同。

#### 系统的分区
系统分区实现了应用控制的分区，不需要数据库控制数据的存储。数据库只提供分区的能力，不知道具体的分区信息。所有的层面的分区操作都由应用控制。往系统分区表里插入数据时，如果不显式的指定分区，插入将失败。

系统分区提供了分区的好处，但是需要应用控制具体的分区和存储。

#### 信息生命周期管理和分区
分区在ILM中扮演关键角色，它可以将数据分组（即分区），分散到不同的存储设备上并可以单独管理。

#### LOB 数据和分区
LOB数据也能被分区。当表被分区时，所有的列存放在分区的表空间里，但是LOB字段，存储在它们自己的表空间里。
这种技术非常有用，因为LOB字段和主要数据分开存储存储，当主要数据经常更新，LOB保持稳定时，非常有益。

#### 分区的好处
分区可以提高性能，方便管理，提高可用性。也可以简化常用的管理任务。
分区可以应对很多前沿应用，分区是简历数T大小数据库或高可用系统的关键应用。
##### 分区提高性能
通过限制检查和操作的数据量及可以进行并行处理的数据分布，分区提供很多有关性能的好处。包括：
* 分区修剪
* 分区连接

###### 分区修剪
分区修剪是最简单而且最稳健的通过分区进行性能提升的方式。可以提高查询性能几个量级。例如订单表`Orders`包含历史订单信息，将这些信息按照周进行分区，查询某周的分期，将只访问单个分区。加入`Orders`表有2年的数据，查询将只访问一个分区，而不是104个分区，因为分区修建，这个查询将快100倍。

分区修建可以和Oracle的所有其他性能优化特性协同工作。Oracle将分区修剪、索引、连接、并行访问联合起来使用。
###### 分区连接
分区可以通过分区连接提升多表连接的性能。当两个分区表进行连接，连接的字段正好是分区字段，或者当分区表和父表进行连接时，可以使用分区连接。分区连接将大的连接分解成分区间更小的连接，在更短的时间里完成整体的连接。对并行和串行的操作都有非常大的提升。

#### 分区与管理
分区允许表和索引分解到更小的，更易管理的单位，让数据库管理员可以分而治之。有了分区，维护操作可以只专注于表的个别分区。例如，管理员可以只备份一个分区。对于整库对象的维护操作，可以分解到单个分区为基础。将维护过程分解到更易管理的区块。

分区在管理上的典型应用是支持数据仓库的“滚动窗口”加载进程。加入DBA按周将新数据加载到表中，可以讲该表按周分区。加载操作只需简单的通过分区交换加载一个新分区，添加一个分区比修改整个表更高效，因为DBA不需要修改其他分区。

#### 分区和可用性
数据库对象分区使分区保持独立。分区的独立特性是高可用策略的重要组成部分。例如，表的一个分区不可用，所有其他分区可以保持在线并可用。应用程序可以继续在可用分区上执行查询和事务，只要他们不需要访问不可用分区，上述数据库操作将能顺利完成。

管理员可以将每个分区放在不同的表空间；最常用的场景是将不同的表空间放在不同的存储上。将分区放在不同的表空间允许数据库管理元对单个分区进行备份和还原，进而可以让数据库激活的部分可以尽快可用，系统可以继续运行，同时非活动数据继续恢复。分区可以减少停机时间。分区带来的高性能，可以让管理员在更小的批次窗口上完成大数据库对象的维护。

### 分区策略
Oracle提供了三个基本的数据分区方法，分别是：
* 范围分区（Range）
* 哈希分区(Hash)
* 列表分区(List)

使用这些分区方法，数据可以实现单层分区或者组合分区：
* 单层分区
* 组合分区
每种策略有不同的的有事和设计考量，因此，各个分区策略都有最适用场景。

#### 单层分区
单层分区使用下面的一种分区方法，使用一个或多个分区键：
* 范围分区
* 哈希分区
* 列表分区

例如,一个表使用`NUMBER`类型的字段作为分区键,分为`less_than_five_hundred`和`less_than_one_thousand`两区。`less_than_one_thousand`分区讲包含符合下列条件的行：

```
500 <= Partitioning key < 1000
```

三种分区策略示意图：
![Figure 2-2](/images/Posts/OracleVLDBPartitioning/fg2-2.gif)
##### 范围分区
范围分区根据分区键值的取值范围来为每个分区映射数据。是最常见的分区分区类型，经常使用日期类型字段。

每个分区包含一个`VALUES LESS THAN`语句，用来确定分区的上界（不包含上界）。大于等于该上界的分区，倍加入下一个更高的分区。除了第一个分区，所有的分区都包含一个隐含的由前一个分区的`VALUES LESS THAN`子句确定的下界。

`MAXVALUE`字面量用来定义最大的分区。`MAXVALUE`代表虚拟的无穷值，比分区键所有的其他的值都大，包含NULL值。

##### 哈希分区
Hash分区根据分区键的哈希值进行分区。哈希分区均匀的将表的数据行分散到各个分区，各个分区的大小大体一样。

哈希分区是讲数据均匀的分配到不同设备上的理想方法。哈希分区比范围分区更好用，尤其是当数据不是历史的或者没有明显的分区键时。
> 哈希算法无法改变

##### 列表分区
列表分区提供描述分区的一系列分散值来显式的控制数据行和分区的映射。列表分区的优势是可以自然的分组和组织无序的、不相关的数据集。例如一个用地区作为分区键，北美分区可能包含加拿大、美国和墨西哥。

‘DEFAULT’分区用来设置默一个默认分区，当没有其他匹配的分区时，不会报错。

#### 组合分区
组合分区是基本分区方法的组合；数据表先用一种分区方式进行分区，然后每个分区使用第二种分区方式进一步进行分区。每个分区的子分区代表数据的逻辑子集。

组合分区支持历史数据操作，例如添加新的范围分区，而且通过子分区支持更高阶数据修建和更好的数据分散粒度。

组合分区示例：
![Figure 2-3](/images/Posts/OracleVLDBPartitioning/fg-2-3.gif)

所有的组合分区类型
* 范围-范围组合分区
* 范围-哈希组合分区
* 范围-列表组合分区
* 列表-范围组合分区
* 列表-哈希组合分区
* 列表-列表组合分区

### 分区扩展
* 管理扩展
* 分区键扩展

#### 管理扩展
这些扩展显著的提高了分区表的易管理性
* 间隔分区
* 分区顾问

##### 间隔分区
间隔分区可以指导数据库当插入表中的数据超出所有分区范围后自动新建分区的范围分区扩展。至少要建立一个范围分区。范围分区键值决定着范围分区的最大值，这个值叫做转换点，数据库为超过转换点的数据建立间隔分区。每个分区的下界是上个范围分区的上界（不包含）。
间隔分区有如下限制：
* 只能使用一个分区键，只能是`NUMBER`或`DATE`类型。
* 索引组织表不支持间隔分区。
* 不能在间隔分区表上建立域索引。
间隔索引可以建立如下类型的组合索引：
* 间隔-范围组合索引
* 间隔-哈希组合索引
* 间隔-列表组合索引

##### 分区顾问
分区顾问是SQL访问顾问的一部分。

#### 分区键扩展
这些扩展增加了定义分区表的灵活性。
##### 引用分区
引用分区支持两个通过引用约束相互关联的两个表的分区。分区键通过现有的父子关系获得，通过启用和激活主键和外键约束加强。

引用分区的优势是对包含父子关系的表，可以无差别的根据继承的父表的字段进行分区，而不用复制这些键值。逻辑依赖关系自动级联分区操作，使程序开发轻松，更不容易出错。

__*非引用分区和引用分区区别示意*__

![Figure 2-4](/images/Posts/OracleVLDBPartitioning/fg-2-4.gif)

![Figure 2-5](/images/Posts/OracleVLDBPartitioning/fg-2-5.gif)

基本分区策略可以使用引用分区，但是间隔分区不行。

##### 虚字段分区
Oracle 11G 允许计算字段参与分区。计算表达式作为元数据存储。

虚字段分区支持基本的分区策略，包括间隔分区和间隔组合分区。

### 分区索引概览

分区索引可以带来易用性、可用性、高性能、可伸缩。索引可以独立分区（全局索引），也可以和表分区关联分区（本地索引）。总体上，在OLTP系统中使用全局索引，在数据仓库或DSS系统中，使用本地索引。尽可能使用本地索引，因为它们好管理。选用何种索引的指导如下：
1. 如果分区列是索引列的子集， 使用本地索引。如果不是，看第2条。
2. 如果索引是唯一的并且不包含分区字段，使用全局索引。否则，看第3条建议
3. 如果易管理更重要，使用本地索引，否则看第4条建议。
4. 如果当前系统是OLTP，用户需要快速响应，使用全局索引。如果系统是DSS，用户更注重结果，那么使用本地索引。

#### 本地分区索引
本地索引和表分区一一对应，更方便管理。单个分区数据无效或不可用时，只影响单个分区。常用语DSS系统。

不能显式的添加本地索引分区，只有为底层表添加新分区时，才会添加新的本地索引分区。同样也不能显式的删除本地索引的分区。只有删除底层表的分区时，才会删除本地索引分区。

本地索引可以是唯一的。为了使本地索引唯一，表的分区键必须是索引键的一部分。

**_本地索引示意图_**

![Figure 2-6](/images/Posts/OracleVLDBPartitioning/fg-2-6.gif)

#### 全局分区索引
Oracle有两种类型的全局分区索引：范围分区和哈希分区。
##### 全局范围分区索引
全局分区索引很灵活，分区的粒度和分区的键和表分区独立。

全局分区索引的最高分区必须包含值为`MAXVALUE`的边界。确保底层表的行都可以在索引中表示。全局前缀索引可以唯一也可以不唯一。
不能为全局索引添加分区，因为最高分区的一个边界是`MAXVALUE`，如果想添加新的最高分区，可以使用`ALTER INDEX SPLIT INDEX`语句。如果全局分区索引是空的，可以删除它。如果全局索引包含数据，删除分区，导致下一个最高分区标记为不可用。不能删除全局索引的最高分区。

##### 全局哈希分区索引
当索引单向增加时，全局哈希索引通过分散争端来提高性能。索引插入只发生在特定的索引边缘。

##### 维护全局分区索引
默认情况下，下列对堆组织表的分区的操作将标记所有的全局索引不可用。
```
ADD (HASH)

COALESCE (HASH)

DROP

EXCHANGE

MERGE

MOVE

SPLIT

TRUNCATE
```
在这些操作的后面添加`UPDATE INDEXS`语句来维护索引。维护全局索引的优势如下：
* 索引始终有效，因此当前操作不影响其他应用。
* 当前操作执行后，不需要重建索引。

**_全局分区索引示意图_**
![Figure 2-7](/images/Posts/OracleVLDBPartitioning/fg-2-7.gif)

#### 全局非分区索引
全局非分区索引和非分区索引没有区别。
_**全局非分区索引示意图**_
![Figure 2-8](/images/Posts/OracleVLDBPartitioning/fg-2-8.gif)

#### 分区表的其他信息
可以在分区表上建立位图索引，位图索引只能是本地索引，不能使全局索引。

全局索引可以唯一。只有分区键是索引键的组成部分时，本地索引才能唯一。

#### 在组合分区表上使用分区索引的两点注意事项：
* 子分区的索引总是本地索引，和表的子分区存储在一起
* 可以在索引或子分区索引级别指定表空间。


#### 新建范围分区表和全局索引
`CREATE TABLE`语句的`PATITION BY RANGE`子句定义范围分区。
